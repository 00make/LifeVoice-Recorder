# LifeOS Unified Event Bus Specs

本规范用于统一 Swarm 内部各组件（Sensor, Core, Agents, UI）之间的消息传递标准。

## 1. 事件包裹结构 (Envelope)

所有事件（无论是通过 RabbitMQ, Redis Pub/Sub 还是 Webhook 传输）必须遵循此结构。

```json
{
  "event_id": "uuid-v4",
  "event_type": "domain.entity.action",
  "source": "sensor-android|core-orchestrator|agent-summarizer",
  "timestamp": "ISO-8601",
  "priority": "high|normal|low",
  "payload": {}
}
```

## 2. 关键事件定义 (Event Registry)

### 2.1 Context Domain (感知域)

- **`context.situation.updated`**
  - *Trigger*: Context Engine 完成多模态融合后。
  - *Payload*: `{"location": "Home", "state": "Focus", "active_sops": ["sop_coding"]}`
  - *Consumer*: `Orchestrator`, `DashboardUI`

### 2.2 Tactical Domain (战术域 / SOP)

- **`tactical.sop.triggered`**
  - *Trigger*: 当某个 SOP 的触发条件被满足时。
  - *Payload*: `{"sop_id": "...", "trigger_reason": "Context matched: @Gym"}`
- **`tactical.task.spawned`**
  - *Trigger*: Orchestrator 创建了新的 Worker Agent。
  - *Payload*: `{"task_id": "...", "agent_role": "coder", "parent_sop": "..."}`

### 2.3 Sensory Domain (原始数据域)

- **`sensory.audio.ingested`**
  - *Trigger*: NAS 完成文件落盘。
  - *Tag*: `intent:command` vs `type:background`.

## 3. 优先级队列定义

- **High Priority Queue (`queue_fast`)**:
  - `intent:command` 的语音。
  - `context.diff` (状态突变)。
  - `agent.error` (报警)。
- **Normal Queue (`queue_std`)**:
  - 普通对话摘要。
  - SOP 执行步骤日志。
- **Low Queue (`queue_arch`)**:
  - 纯背景噪音录音。
  - 定期心跳 (Heartbeat)。

- `transcript.generated`
- `summary.generated`

### 2.4 反馈 → 行动

- `notification.requested`
- `tts.requested`

### 2.5 闭环学习

- `feedback.user.confirmed`
- `feedback.user.corrected`

## 3. Payload 规范示例

### 3.1 audio.segment.created

```json
{
  "segment_id": "seg_20260212_0001",
  "path": "raw/audio/2026-02-12/seg_0001.opus",
  "duration_ms": 120000,
  "device_id": "android_01",
  "hash_sha256": "...",
  "encrypted": true
}
```

### 3.2 transcript.generated

```json
{
  "segment_id": "seg_20260212_0001",
  "language": "zh",
  "model": "whisper-large-v3",
  "text": "...",
  "confidence": 0.93
}
```

### 3.3 notification.requested

```json
{
  "priority": "P1",
  "title": "今日关键洞察",
  "body": "你在工作时多次提到X",
  "action": "open_memos",
  "target": "android"
}
```

## 4. 日志规范

- 每个事件必须写入 `event_log` 表。
- 字段：`event_id` / `event_type` / `source` / `timestamp` / `payload_hash`。

## 5. 版本兼容

- `event_type` 新增字段需保持向后兼容。
- `payload` 可扩展，但不得破坏已有字段。
