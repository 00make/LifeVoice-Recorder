# Evolution Engine Implementation Guide (SOP Distiller)

本指南指导如何构建 **SOP Distillation Pipeline** (从日志中生成 SOP) 和 **Self-Healing Mechanism**，这是 Swarm 的进化引擎。

## 1. 核心工具 (Distillation Stack)

- **Unsloth**: 用于 Style LoRA 微调 (针对 Writer Agent)。
- **DSPy**: 用于 Analyst Agent 的 Prompt 优化。
- **Neo4j**: 存储 Action 成功率，作为进化的 "Fitness Function"。

## 2. 实施流水线 (The Continuous Improvement Loop)

### 2.1 SOP 蒸馏 (from Actions to Rules)

脚本 `brain/evolution/distill_sop.py` (Planned)，周期性运行：
1. **Query**: 从 Neo4j 查询当天所有成功的 `Action` 节点。
   `MATCH (a:Action {status: 'success'})<-[:EXECUTED]-(agent) RETURN a.logs`
2. **Cluster**: 将相似的 Action 聚类。
3. **Draft**: 让 `Analyst Agent` 撰写通用流程，生成标准 SOP 格式。
   - *Result*: 生成 `knowledge/SOPs/draft_sop_xxx.md`。
   - *Format*: 必须包含 YAML Frontmatter (`id`, `trigger`, `roles`) 和 Steps。
4. **Integration**: 将新 SOP 提交到 Git Repo (Pending Review 状态)。

### 2.2 知识图谱固化 (Memory Consolidation)

脚本 `brain/evolution/consolidate_graph.py` (Planned)：
1. 读取短期记忆 log。
2. 更新 Neo4j 中的 `Entity` 属性 (e.g., User preference)。
3. 为 `ContextManager` 更新 Trigger 权重 (优化 `brain/context_watcher.py` 逻辑)。

### 2.3 风格微调 (Style LoRA)

针对 `Writer` 角色：
1. 导出用户过去一周修改过的 Memos (Ground Truth)。
2. 构造 Alpaca 格式数据集。
3. 调用 `Unsloth` 微调，并更新 `config/config.yaml` 中的模型指向。

### 2.4 Prompt 优化 (DSPy)

针对 `Analyst` 角色：

```python
# 定义一个 DSPy Module
class RAG(dspy.Module):
    # ... 自动优化 Prompt 策略 ...
```

## 3. 回滚机制 (Safety Net)

每当 updates 导致 SOP 执行成功率下降 > 5% 时：

1. 自动调用 git revert 回滚 SOP。
2. 发送 Alert 给 Admin。

