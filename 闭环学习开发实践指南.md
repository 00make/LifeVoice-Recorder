# Evolution Engine Implementation Guide (SOP Distiller)

本指南指导如何构建 **SOP Distillation Pipeline** (从日志中生成 SOP) 和 **Self-Healing Mechanism**。

## 1. 核心工具 (Distillation Stack)

- **Unsloth**: 用于 Style LoRA 微调。
- **DSPy**: 用于 Prompt 优化。
- **LangGraph**: 用于构建复盘流程。

## 2. 实施流水线 (The Nightly Routine)

### 2.1 SOP 蒸馏 (from Actions to Rules)

脚本 `distill_sop.py`，Crontab 每天 03:00 运行：
1. **Query**: 从 Neo4j 查询当天所有成功的 `Action` 节点。
   `MATCH (a:Action {status: 'success'})<-[:EXECUTED]-(agent) RETURN a.logs, a.tool_calls`
2. **Cluster**: 将相似的 Action 聚类 (e.g., "Extracted text from PDF" x 5)。
3. **Draft**: 让 `Analyst Agent` 撰写通用流程。
   - *Result*: 生成 `SOP_draft_pdf_extraction.md`.
4. **Integration**: 将新 SOP 提交到 Git Repo (Pending Review 状态)。

### 2.2 记忆固化 (Memory Consolidation)

脚本 `consolidate_memory.py`，Crontab 每天 03:00 运行：
1. `SELECT * FROM short_term_memory WHERE timestamp > yesterday`.
2. 使用 `Summarizer Agent` 提取 Key Facts (e.g., "User likes spicy food").
3. 存入 ChromaDB: `collection.add(documents=[fact], metadatas=[{'date': '...'}])`.
4. 清空 Redis 中无用的对话废料。

### 2.2 风格微调 (Style LoRA)

脚本 `finetune_style.py`，每周日 04:00 运行：
1. 导出用户过去一周修改过的 Memos (Ground Truth)。
2. 构造 Alpaca 格式数据集: `{"instruction": "Write a diary", "output": "User's actual text"}`.
3. 调用 `Unsloth` 跑 3 个 Epoch。
4. 热加载新的 LoRA Adapter。

### 2.3 Prompt 优化 (DSPy Teleprompter)

```python
# 定义一个 DSPy Module
class RAG(dspy.Module):
    def __init__(self):
        self.retrieve = dspy.Retrieve(k=3)
        self.generate = dspy.ChainOfThought("context, question -> answer")

# 定义 metric
def validate_answer(example, pred, trace=None):
    return dspy.evaluate.answer_exact_match(example, pred)

# 自动优化
teleprompter = BootstrapFewShot(metric=validate_answer)
compiled_rag = teleprompter.compile(RAG(), trainset=trainset)
```

## 3. 回滚机制 (Safety Net)

每当更新 LoRA 或 Prompt 后，必须跑一遍 **Sanity Check Set** (一组 50 个固定问题)。
如果通过率下降 > 5%，自动回滚到上一版本并报警。
