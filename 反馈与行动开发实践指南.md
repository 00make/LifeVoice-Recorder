# LifeOS Action Implementation Guide (Effector Node)

本指南指导如何让 Agent 具备“手”和“脚”，安全地执行 SOP 定义的 Actions。

## 1. 核心库 (Tools Integration)

- **Execution Environment**:
  - `Docker SDK`: 用于本地沙箱执行.
  - `E2B`: Cloud-hosted sandboxes (可选).
- **Control Interface**:
  - `FastAPI`: 接收 Action 指令.

## 2. 接口定义 (Action Schema)

每个 SOP 中的 Action 必须映射到一个具体的 Python Function 或 API Call。

```python
# actions/email_actions.py
@tool
def send_email(to: str, subject: str, body: str, requires_approval=True):
    """Sends an email via Gmail API."""
    if requires_approval:
        raise NeedApprovalException("User confirmation required.")
    # ... implementation
```

### 2.1 Action Router Implementation

```python
# router.py
def execute_action(action_request):
    """
    Input: {"tool": "send_email", "args": {...}}
    """
    tool = tool_registry.get(action_request['tool'])
    try:
        return tool.run(action_request['args'])
    except NeedApprovalException:
        push_notification("Approve email?")
        return "PENDING_APPROVAL"
```

## 3. 安全沙箱 (Sandbox)

为了防止 Agent 写出 `.rm -rf /`，我们使用 Docker 作为隔离层。

```python
# executor.py
def run_unsafe_code(code: str):
    client = docker.from_env()
    container = client.containers.run(
        "python:3.10-slim",
        command=["python", "-c", code],
        mem_limit="128m",
        network_disabled=True, # 禁止联网
        detach=True
    )
    # ... wait and capture logs
```

## 4. 人机确认 (Human-in-the-Loop)

当 Agent 尝试调用危险 Tool (`requires_approval=True`) 时：
1. 暂停 Graph 执行，序列化当前 State。
2. 生成一个 UUID `approval_id`。
3. 推送通知给用户手机: "Agent 请求执行 X，点击 [Link] 批准"。
4. 等待用户回调 `/approve/{id}`，再反序列化 State 继续执行。
